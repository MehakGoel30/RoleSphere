<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard</title>
    <link rel="stylesheet" href="/employee.css" />
  </head>
  <body>
    <div class="sidebar">
      <h3>Employee Panel</h3>
      <a href="#" onclick="showProfile()">Profile</a>
      <a href="#" onclick="applyLeave()">Apply Leave</a>
      <a href="#" onclick="showLeaveHistory()">Leave History</a>
      <a href="#" onclick="showWorkReports()">My Work Reports</a>
      <a href="#" onclick="showTodoPage()">To Do List</a>
      <a href="#" onclick="showAttendance()">My Attendance</a>
    </div>

    <div class="main-content">
      <div class="navbar">
        <span>Employee Dashboard</span>
        <a href="/employee/logout" class="logout-btn">Logout</a>
      </div>

      <div class="welcome-container" id="welcomeContainer">
        Welcome to Employee Panel!
      </div>

      <div class="card-container">
        <div class="card" onclick="showProfile()">Edit Profile</div>
        <div class="card" onclick="applyLeave()">Apply Leave</div>
        <div class="card" onclick="showWorkReports()">My Work Reports</div>
        <div class="card" onclick="showTodoPage()">To Do list</div>
        <div class="card" onclick="showAttendance()">My Attendance</div>
      </div>

      <!-- Profile Section -->
      <div class="container" id="profileSection" style="display: none">
        <h2>User Profile</h2>
        <div id="viewProfile">
          <p><strong>Name:</strong> <span id="profileName"></span></p>
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p>
            <strong>Phone:</strong>
            <span id="profilePhone">Fill the details</span>
          </p>
          <p>
            <strong>Address:</strong>
            <span id="profileAddress">Fill the details</span>
          </p>
          <p>
            <strong>Department:</strong>
            <span id="profileDepartment">Fill the details</span>
          </p>
          <button class="btn" onclick="editProfile()">Edit Profile</button>
        </div>
        
        <div id="editProfile" style="display: none">
          <form onsubmit="updateProfile(event)">
            <div class="input-group">
              <label for="name">Name:</label>
              <input type="text" id="name" name="name" required />
            </div>
            <div class="input-group">
              <label for="email">Email:</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="input-group">
              <label for="phone">Phone:</label>
              <input type="text" id="phone" name="phone" />
            </div>
            <div class="input-group">
              <label for="address">Address:</label>
              <input type="text" id="address" name="address" />
            </div>
            <div class="input-group">
              <label for="department">Department:</label>
              <input type="text" id="department" name="department" />
            </div>
            <button type="submit" class="btn">Update Profile</button>
          </form>
        </div>
      </div>

      <!-- Apply Leave Section -->
      <div class="container" id="leaveSection" style="display: none">
        <h2>Apply for Leave</h2>
        <form id="leaveForm">
          <div class="input-group">
            <label for="leaveStartDate">Leave Start Date:</label>
            <input
              type="date"
              id="leaveStartDate"
              name="leaveStartDate"
              required
            />
          </div>
          <div class="input-group">
            <label for="leaveEndDate">Leave End Date:</label>
            <input type="date" id="leaveEndDate" name="leaveEndDate" required />
          </div>
          <div class="input-group">
            <label for="leaveReason">Reason for Leave:</label>
            <input type="text" id="leaveReason" name="leaveReason" required />
          </div>
          <button type="submit" class="btn">Apply Leave</button>
        </form>
        <div id="leaveStatus" style="display: none">
          Leave Applied Successfully!
        </div>
      </div>

      <!-- Leave History Section -->
      <div class="container" id="leaveHistory" style="display: none">
        <h2>Leave History</h2>
        <div id="historyContent"></div>
      </div>

      <!-- Work Reports Section -->
      <div class="container" id="workReportsSection" style="display: none">
        <h2>Submit Work Report</h2>
        <form id="workReportForm">
          <div class="input-group">
            <label for="reportStartDate">Start Date:</label>
            <input
              type="date"
              id="reportStartDate"
              name="reportStartDate"
              required
            />
          </div>
          <div class="input-group">
            <label for="reportEndDate">End Date:</label>
            <input
              type="date"
              id="reportEndDate"
              name="reportEndDate"
              required
            />
          </div>
          <div class="input-group">
            <label for="totalHours">Total Working Hours:</label>
            <input
              type="number"
              id="totalHours"
              name="totalHours"
              min="1"
              max="24"
              required
            />
          </div>
          <div class="input-group">
            <label for="reportName">Report Name:</label>
            <input type="text" id="reportName" name="reportName" required />
          </div>
          <div class="input-group">
            <label for="reportDescription">Work Description:</label>
            <textarea
              id="reportDescription"
              name="reportDescription"
              required
            ></textarea>
          </div>
          <button type="submit" class="btn">Submit Report</button>
          <div
            id="reportStatus"
            style="display: none; margin-top: 15px; padding: 10px"
          ></div>
        </form>

        <!-- Report History Section -->
        <div class="report-history-container">
          <h3>Report History</h3>
          <button class="toggle-history-btn" onclick="toggleReportHistory()">
            Show History
          </button>
          <div id="reportHistory" style="display: none">
            <table id="reportHistoryTable">
              <thead>
                <tr>
                  <th>Report Name</th>
                  <th>Period</th>
                  <th>Hours</th>
                  <th>Status</th>
                  <th>Submitted On</th>
                </tr>
              </thead>
              <tbody id="reportHistoryBody">
                <!-- Reports will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- To-Do List Section -->
      <div class="container" id="todoSection" style="display: none">
        <h2>My Tasks</h2>
        <div class="todo-container">
          <input type="text" id="todoInput" placeholder="Add a new task..." />
          <button id="addTodoBtn" onclick="addTodo()">Add</button>
          <ul class="todo-list" id="todoList"></ul>
        </div>
      </div>
      <!-- Attendance Section -->
<div class="container" id="attendanceSection" style="display: none">
  <h2>My Attendance</h2>
  <div class="attendance-summary">
    <p>Present: <span id="presentCount">0</span> days</p>
    <p>Absent: <span id="absentCount">0</span> days</p>
    <p>Total Marked: <span id="totalDays">0</span> days</p>
  </div>
  <div class="attendance-table">
    <table>
      <thead>
        <tr>
          <th >Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="attendanceRecords">
        <!-- Records will be loaded here -->
      </tbody>
    </table>
  </div>
</div>
</div>
    </div>

    <script>
      // Global state
      let currentEmployee = {};

      // Utility Functions
      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString();
      }

      function formatDateTime(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      function getStatusColor(status) {
        switch (status?.toLowerCase()) {
          case "approved": return "green";
          case "rejected": return "red";
          default: return "orange";
        }
      }

      function hideAllSections() {
        document.getElementById("profileSection").style.display = "none";
        document.getElementById("leaveSection").style.display = "none";
        document.getElementById("leaveHistory").style.display = "none";
        document.getElementById("workReportsSection").style.display = "none";
        document.getElementById("welcomeContainer").style.display = "none";
        document.querySelector(".card-container").style.display = "none";
        document.getElementById("todoSection").style.display = "none";
        document.getElementById("attendanceSection").style.display = "none";
      }

      function showDefaultView() {
        document.getElementById("welcomeContainer").style.display = "block";
        document.querySelector(".card-container").style.display = "flex";
        hideAllSections();
      }

      // Navigation Functions
      function showProfile() {
        hideAllSections();
        document.getElementById("profileSection").style.display = "block";
      }

      function editProfile() {
        document.getElementById("viewProfile").style.display = "none";
        document.getElementById("editProfile").style.display = "flex";
      }

      function applyLeave() {
        hideAllSections();
        document.getElementById("leaveSection").style.display = "block";
      }

      function showLeaveHistory() {
        hideAllSections();
        document.getElementById("leaveHistory").style.display = "block";
        loadLeaveHistory();
      }

      function showWorkReports() {
        hideAllSections();
        document.getElementById("workReportsSection").style.display = "block";
        document.getElementById("workReportForm").reset();
        document.getElementById("reportStatus").style.display = "none";
        document.getElementById("reportHistory").style.display = "none";
      }

      function showTodoPage() {
        hideAllSections();
        document.getElementById("todoSection").style.display = "block";
        loadTodos();
      }

      // Profile Management
      async function loadProfileData() {
        try {
          const response = await fetch("/employee/getProfile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: currentEmployee.email })
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to load profile");
          }

          // Update current employee data
          currentEmployee = { ...currentEmployee, ...data.profile };

          // Update profile display
          document.getElementById("profileName").innerText = currentEmployee.name;
          document.getElementById("profileEmail").innerText = currentEmployee.email;
          document.getElementById("profilePhone").innerText = currentEmployee.phone || "Fill the details";
          document.getElementById("profileAddress").innerText = currentEmployee.address || "Fill the details";
          document.getElementById("profileDepartment").innerText = currentEmployee.department || "Fill the details";

          // Pre-fill edit form
          document.getElementById("name").value = currentEmployee.name;
          document.getElementById("email").value = currentEmployee.email;
          document.getElementById("phone").value = currentEmployee.phone || "";
          document.getElementById("address").value = currentEmployee.address || "";
          document.getElementById("department").value = currentEmployee.department || "";
        } catch (error) {
          console.error("Error loading profile:", error);
          // Fallback to basic data
          document.getElementById("profileName").innerText = currentEmployee.name;
          document.getElementById("profileEmail").innerText = currentEmployee.email;
        }
      }

      async function updateProfile(event) {
        event.preventDefault();

        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = "Updating...";

        try {
          const updatedData = {
            email: currentEmployee.email,
            name: document.getElementById("name").value,
            phone: document.getElementById("phone").value,
            address: document.getElementById("address").value,
            department: document.getElementById("department").value,
          };

          const response = await fetch("/employee/updateProfile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData)
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to update profile");
          }

          // Update current employee data
          currentEmployee = { ...currentEmployee, ...data.profile };

          // Update profile display
          document.getElementById("profileName").innerText = currentEmployee.name;
          document.getElementById("profileEmail").innerText = currentEmployee.email;
          document.getElementById("profilePhone").innerText = currentEmployee.phone || "Fill the details";
          document.getElementById("profileAddress").innerText = currentEmployee.address || "Fill the details";
          document.getElementById("profileDepartment").innerText = currentEmployee.department || "Fill the details";

          // Switch back to view mode
          document.getElementById("viewProfile").style.display = "block";
          document.getElementById("editProfile").style.display = "none";
        } catch (error) {
          console.error("Error updating profile:", error);
          alert("Failed to update profile. Please try again.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Update Profile";
        }
      }

      // Leave Management
      function submitLeaveForm() {
        const startDate = document.getElementById("leaveStartDate").value;
        const endDate = document.getElementById("leaveEndDate").value;
        const reason = document.getElementById("leaveReason").value;

        fetch("/employee/applyLeave", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: currentEmployee.email,
            startDate,
            endDate,
            reason,
          }),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              document.getElementById("leaveStatus").style.display = "block";
              setTimeout(() => {
                document.getElementById("leaveStatus").style.display = "none";
                document.getElementById("leaveSection").style.display = "none";
                loadLeaveHistory();
              }, 2000);
            } else {
              alert("Error applying leave: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error applying leave. Please try again.");
          });
      }

      function loadLeaveHistory() {
        fetch("/employee/getLeaves", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: currentEmployee.email }),
        })
          .then((response) => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              displayLeaveHistory(data.leaves || []);
            } else {
              console.error("Error fetching leave history:", data.error);
              document.getElementById("historyContent").innerHTML =
                "<p>Error loading leave history. Please try again.</p>";
            }
          })
          .catch((err) => {
            console.error("Error fetching leave history:", err);
            document.getElementById("historyContent").innerHTML =
              "<p>Error loading leave history. Please try again.</p>";
          });
      }

      function displayLeaveHistory(history) {
        const container = document.getElementById("historyContent");

        if (!Array.isArray(history) || history.length === 0) {
          container.innerHTML = "<p>No leave history found.</p>";
          return;
        }

        container.innerHTML = history
          .map((leave, index) => {
            const status = leave.status || "Pending";
            const color = status === "Approved" ? "green" : 
                         status === "Rejected" ? "red" : "orange";

            return `
              <div class="leave-item" style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee;">
                <p><strong>Leave ${index + 1}:</strong> ${new Date(leave.startDate).toLocaleDateString()} 
                to ${new Date(leave.endDate).toLocaleDateString()}</p>
                <p><strong>Reason:</strong> ${leave.reason}</p>
                <p>Status: <span style="color: ${color}"><strong>${status}</strong></span></p>
              </div>`;
          })
          .join("");
      }

      // Work Reports Management
      function showReportStatus(message, isSuccess) {
        const statusElement = document.getElementById("reportStatus");
        statusElement.textContent = message;
        statusElement.style.color = isSuccess ? "green" : "red";
        statusElement.style.display = "block";
      }

      async function submitWorkReport() {
        const reportData = {
          employeeId: currentEmployee.email,
          startDate: document.getElementById("reportStartDate").value,
          endDate: document.getElementById("reportEndDate").value,
          totalHours: document.getElementById("totalHours").value,
          reportName: document.getElementById("reportName").value,
          description: document.getElementById("reportDescription").value,
        };

        if (new Date(reportData.endDate) < new Date(reportData.startDate)) {
          showReportStatus("End date cannot be before start date", false);
          return;
        }

        const submitBtn = document.querySelector("#workReportForm button[type='submit']");
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        try {
          const response = await fetch("/employee/submitWorkReport", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reportData),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to submit report");
          }

          showReportStatus("Work report submitted successfully!", true);

          setTimeout(() => {
            document.getElementById("workReportForm").reset();
            loadReportHistory();
          }, 2000);
        } catch (error) {
          console.error("Submission error:", error);
          showReportStatus(error.message, false);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Report";
        }
      }

      async function loadReportHistory() {
        try {
          const response = await fetch("/employee/getWorkReports", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: currentEmployee.email }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to load reports");
          }

          displayReportHistory(data.reports || []);
        } catch (error) {
          console.error("Error loading work reports:", error);
          document.getElementById("reportHistoryBody").innerHTML = 
            `<tr><td colspan="5">Error loading report history. Please try again.</td></tr>`;
        }
      }

      function displayReportHistory(reports) {
        const tbody = document.getElementById("reportHistoryBody");

        tbody.innerHTML = reports
          .map((report) => `
            <tr>
              <td>${report.reportName}</td>
              <td>${formatDate(report.startDate)} - ${formatDate(report.endDate)}</td>
              <td>${report.totalHours}</td>
              <td style="color: ${getStatusColor(report.status)}">
                ${report.status}
                ${report.managerComment ? `<br><small>${report.managerComment}</small>` : ""}
              </td>
              <td>${formatDateTime(report.submittedAt)}</td>
            </tr>
          `).join("");
      }

      function toggleReportHistory() {
        const historyDiv = document.getElementById("reportHistory");
        const toggleBtn = document.querySelector(".toggle-history-btn");

        if (historyDiv.style.display === "none") {
          historyDiv.style.display = "block";
          toggleBtn.textContent = "Hide History";
          if (document.getElementById("reportHistoryBody").children.length === 0) {
            loadReportHistory();
          }
        } else {
          historyDiv.style.display = "none";
          toggleBtn.textContent = "Show History";
        }
      }

      // Todo Management
      async function loadTodos() {
        try {
          const response = await fetch("/employee/getTodos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: currentEmployee.email }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to load todos");
          }

          displayTodos(data.todos || []);
        } catch (error) {
          console.error("Error loading todos:", error);
          const todoList = document.getElementById("todoList");
          todoList.innerHTML = "<li>Error loading todos. Please try again.</li>";
        }
      }

      function displayTodos(todos) {
        const todoList = document.getElementById("todoList");
        todoList.innerHTML = "";

        if (!todos || todos.length === 0) {
          todoList.innerHTML = "<li>No tasks found. Add your first task!</li>";
          return;
        }

        todos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        todos.forEach((todo) => {
          const li = document.createElement("li");
          li.className = `todo-item ${todo.completed ? "completed" : ""}`;
          li.dataset.id = todo._id;
          li.innerHTML = `
            <span>${todo.text}</span>
            <div class="todo-actions">
              <button onclick="toggleTodo('${todo._id}')">✓</button>
              <button onclick="deleteTodo('${todo._id}')">✕</button>
            </div>
          `;
          todoList.appendChild(li);
        });
      }

      async function addTodo() {
        const input = document.getElementById("todoInput");
        const text = input.value.trim();

        if (!text) return;

        try {
          const response = await fetch("/employee/addTodo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmployee.email,
              text: text,
            }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to add todo");
          }

          input.value = "";
          await loadTodos();
        } catch (error) {
          console.error("Error adding todo:", error);
          alert("Failed to add todo. Please try again.");
        }
      }

      async function toggleTodo(id) {
        try {
          const response = await fetch("/employee/toggleTodo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to toggle todo");
          }

          await loadTodos();
        } catch (error) {
          console.error("Error toggling todo:", error);
          alert("Failed to toggle todo. Please try again.");
        }
      }

      async function deleteTodo(id) {
        if (!confirm("Are you sure you want to delete this task?")) return;

        try {
          const response = await fetch("/employee/deleteTodo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Failed to delete todo");
          }

          await loadTodos();
        } catch (error) {
          console.error("Error deleting todo:", error);
          alert("Failed to delete todo. Please try again.");
        }
      }
      // Navigation function
// Add to your employee dashboard JavaScript

// Navigation function
function showAttendance() {
  hideAllSections();
  document.getElementById("attendanceSection").style.display = "block";
  loadAttendance();
}

// Load attendance data
async function loadAttendance() {
  try {
    const response = await fetch("/employee/getAttendance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: currentEmployee.email }),
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.error || "Failed to load attendance");
    }

    displayAttendance(data.attendance.records, data.summary);
  } catch (error) {
    console.error("Error loading attendance:", error);
    document.getElementById("attendanceRecords").innerHTML = 
      "<tr><td colspan='2'>Error loading attendance data. Please try again.</td></tr>";
  }
}

// Display attendance records
function displayAttendance(records, summary) {
  // Update summary
  document.getElementById("presentCount").textContent = summary.present;
  document.getElementById("absentCount").textContent = summary.absent;
  document.getElementById("totalDays").textContent = summary.total;

  // Display records
  const tbody = document.getElementById("attendanceRecords");
  tbody.innerHTML = "";

  if (!records || records.length === 0) {
    tbody.innerHTML = "<tr><td colspan='2'>No attendance records found</td></tr>";
    return;
  }

  // Sort records by date (newest first)
  records.sort((a, b) => new Date(b.date) - new Date(a.date));

  // Add each record to the table
  records.forEach(record => {
    const row = document.createElement("tr");
    
    const dateCell = document.createElement("td");
    dateCell.textContent = new Date(record.date).toLocaleDateString();
    
    const statusCell = document.createElement("td");
    statusCell.textContent = record.status.charAt(0).toUpperCase() + record.status.slice(1);
    statusCell.className = `status-${record.status}`;
    
    row.appendChild(dateCell);
    row.appendChild(statusCell);
    tbody.appendChild(row);
  });
}

// Don't forget to add attendanceSection to hideAllSections()

    // Initialization
      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);
        currentEmployee.name = decodeURIComponent(urlParams.get("name") || "");
        currentEmployee.email = decodeURIComponent(urlParams.get("email") || "");

        // Load profile data from backend
        await loadProfileData();

        // Set up form submissions
        document.getElementById("leaveForm").addEventListener("submit", (e) => {
          e.preventDefault();
          submitLeaveForm();
        });

        document.getElementById("workReportForm").addEventListener("submit", (e) => {
          e.preventDefault();
          submitWorkReport();
        });

        document.getElementById("todoInput").addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            addTodo();
          }
        });
      };
    </script>
  </body>
</html>